name: CI / Docker Build & Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  ci:
    runs-on: self-hosted
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v5
        with:
          node-version: 18
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Format code
        run: npm run format

      - name: Lint code
        run: npm run lint

      - name: Run tests
        run: npm test -- --watchAll=false

  deploy:
    needs: ci
    runs-on: self-hosted
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Deploy using Docker Compose (Fresh)
        run: |
          set -e
          echo "ğŸš€ Starting fresh deployment..."
          
          # Ensure deployment directory exists
          cd ~/app || mkdir -p ~/app && cd ~/app
          
          # Sync project files from repo
          echo "ğŸ“¦ Copying updated project files..."
          rsync -a --delete $GITHUB_WORKSPACE/ ~/app/
          
          # Stop and remove old containers, volumes, and networks
          echo "ğŸ›‘ Stopping and removing old containers..."
          docker-compose down -v --remove-orphans
          
          # Optional: remove dangling images to avoid conflicts
          echo "ğŸ—‘ï¸ Removing dangling Docker images..."
          docker image prune -f
          
          # Build fresh Docker images
          echo "ğŸ“¦ Building Docker images..."
          docker-compose build --no-cache
          
          # Start containers fresh
          echo "â™»ï¸ Starting containers..."
          docker-compose up -d
          
          echo "âœ… Fresh deployment completed successfully!"
